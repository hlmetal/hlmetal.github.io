---
layout: post
title:  "最佳实践之错误处理、故障应对及协同工作流"
date:   2019-04-01 09:00:30 +0200
categories: 最佳实践
---

在程序中如何规范处理错误，在发生故障时如何优雅的应对，如何使用协同工作流提高开发效率


## 错误处理
* 错误码和异常捕获选择
* 异步编程使用callback方式
* 统一分类错误字典，在一个地方定义相关的错误
* 为错误定义提供清晰文档以及代码示例
* 同类错误的定义最好是可扩展的，以便重用代码
* 定义错误严重程度，分成不层次，例如： error， warning， info， debug
* 错误日志输出使用错误码，而不是错误信息，有利于日志分析软件进行自动化监控
* 同一地方不停报错，不要都打印到日志，而是打出一个错误及其出现次数
* 不要用错误处理逻辑来处理业务逻辑，即不要使用异常捕获方法处理业务逻辑
* 对同类错误的处理，使用同一模式
* 尽可能在错误发生地处理错误，向上尽可能返回原始错误
* 不要把大量的代码都放在一个 try 语句块内
* 异步的方式，推荐使用 Promise 模式
* 分布式的系统，推荐使用 APM 相关的软件

## 故障应对
### 故障发生时
最重要的是快速恢复故障，而快速恢复的前提是快速定位故障源
### 故障前准备
* 以用户功能为索引的服务和资源的全视图
* 为视图中的各个服务制定关键指标，以及一套运维流程和工具，包括应急方案
* 设定故障的等级以及不同故障等级的处理方式和处理流程
* 故障演练
* 灰度发布系统

### 处理
* 重启和限流，主要解决的是可用性的问题
* 回滚操作， 一般是解决新代码的 bug
* 降级操作， 如果无法回滚，就需要降级功能
* 紧急更新，需要一个强大的自动化测试和自动化发布系统

### 复盘
* 记录故障处理全过程，从发生到解决全部细节
* 分析故障原因，反问为什么会发生故障
    * 为什么故障发生到报警时间长？为什么花费很长时间才定位到问题？等等
    * 优化故障获知和故障定位的时间、优化故障的处理方式、优化开发过程中的问题。等等
* 故障后整改计划

## 协同工作流
### 协同的本质
* 不同的团队能够尽可能地并行开发
* 不同软件版本和代码的一致性
* 不同环境和代码的一致性

### working flow
* 中心式协同工作流
* 功能分支协同工作流
* GitFlow
* GitLabFlow
* GitHubFlow
    * 每个开发人员都把“官方库”的代码 fork 到自己的代码仓库中
    * 开发人员在自己的代码仓库中做开发, 在本地建“功能分支”，在这个分支上做代码开发
    * 功能分支push 到开发人员自己的代码仓库
    * 然后向官方库发起 pull request，并做 Code Review
    * CR通过就合并到master

### 软件开发的工作模式
* 以微服务或是 SOA 为架构的方式
    * 一个大型软件会被拆分成若干个服务，代码也会跟着服务拆解成若干个代码仓库；开发团队也会跟服务一样被拆分成多个小团队
* 以 DevOps 为主的开发流程
